<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css">
</head>
<body>
    <header>
        <div class="header-top">
            <div class="header-top-container">

                <div class="header-contact">
                    <span>(+65)</span>
                    <span>Singapore</span>
                </div>
                <p class="header-motto">Shop Smart, Live Better - Your Trusted Online Marketplace!</p>

                <a href="/login/login-signup.html" class="header-top-action">Login<i class='bx bx-user' ></i></a>
            </div>
        </div>

        <div class="nav">
            <div class="nav-logo">
                <h2>Moke<span>Sell</span></h2>
            </div>

            <div class="nav-menu" id="nav-menu">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/index.html" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="/about.html" class="nav-link">About</a>
                    </li>
                    <li class="nav-item">
                        <a href="/products.html" class="nav-link">Products</a>
                    </li>
                    <li class="nav-item">
                        <a href="/list.html" class="nav-link">List</a>
                    </li>
                </ul>
                <div class="header-search" style="position: relative;">
                    <input type="text" placeholder="Search..." class="form-input" id="search-input">
                    <i class='bx bx-search-alt-2' id="search-icon"></i>
                    <!-- Suggestions container -->
                    <div class="search-suggestions" id="search-suggestions"></div>
                </div>
                <div class="header-user-actions">
                    <a href="wishlist.html" class="header-action-btn">
                        <i class='bx bxs-heart' style="color: red;"></i>
                        <span class="count">3</span>
                    </a>
                    <a href="chats.html" class="header-action-btn">
                        <i class='bx bx-message-square-dots' style="color: black;"></i>
                        <span class="count">3</span>
                    </a>
                </div>
                <div class="header-menu">
                    <i class='bx bx-menu'></i>
                </div>
            </div>
        </div>
    </header>
    <main>
        <h3 class="section-title"><span>Popular</span> Categories</h3>
        <div class="categories-container">
            <div class="category-item" onclick="navigateToCategory('sneakers.html')">
                <div class="category-image-container">
                    <img src="/images/aj1 fragment.webp" alt="Sneakers" class="category-img">
                </div>
                <h3 class="category-title">Sneakers</h3>
            </div>
            <div class="category-item" onclick="navigateToCategory('clothing.html')">
                <div class="category-image-container">
                    <img src="/images/pink stussy.webp" alt="Clothing" class="category-img">
                </div>
                <h3 class="category-title">Clothing</h3>
            </div>
            <div class="category-item" onclick="navigateToCategory('electronics.html')">
                <div class="category-image-container">
                    <img src="/images/iphone 16.webp" alt="Watches" class="category-img">
                </div>
                <h3 class="category-title">Electronics</h3>
            </div>
            <div class="category-item" onclick="navigateToCategory('watches.html')">
                <div class="category-image-container">
                    <img src="/images/ap watch.webp" alt="Audio Devices" class="category-img">
                </div>
                <h3 class="category-title">Watches</h3>
            </div>
            <div class="category-item" onclick="navigateToCategory('fragrance.html')">
                <div class="category-image-container">
                    <img src="/images/jpg lmlp.webp" alt="Electronics" class="category-img">
                </div>
                <h3 class="category-title">Fragrance</h3>
            </div>
        </div>
        <div class="products-container" id="products-list">
            <div class="tab-btns">
                <span class="tab-btn">Featured</span>
                <span class="tab-btn">Trending</span>
                <span class="tab-btn">Latest</span>
            </div>
            <div class="tab-items">
                <div class="tab-item active-tab">
                    <div class="products-container">
                        <h3 class="section-title"><span>Featured</span> Listings</h3>
                        <div class="grid"> 
                            <!-- Listings will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Account Sidebar (initially hidden) -->
        <div id="account-sidebar" class="account-sidebar">
            <div class="sidebar-content">
            <span id="close-sidebar" class="close-sidebar">&times;</span>
            <h3>Account Info</h3>
            <div id="user-info">
                <!-- This will be populated with the user's name and email -->
            </div>
            <button id="logout-btn" class="logout-btn">Log Out</button>
            </div>
        </div>
    </main>
    <footer>
        <div class="waves">
            <div class="wave" id="wave1"></div>
            <div class="wave" id="wave2"></div>
            <div class="wave" id="wave3"></div>
            <div class="wave" id="wave4"></div>
        </div>
        <ul class="social-icons">
            <li><a href="#"><i class='bx bxl-instagram-alt'></i></a></li>
            <li><a href="#"><i class='bx bxl-twitter'></i></a></li>
            <li><a href="#"><i class='bx bxl-facebook'></i></a></li>
            <li><a href="#"><i class='bx bxl-linkedin-square'></i></a></li>
        </ul>
        <ul class="menu">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/products.html">Products</a></li>
            <li><a href="/list.html">List</a></li>
        </ul>
        <p>mokesell@gmail.com.sg | +65 8921 2819 | All Rights Reserved</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // fetching listings for FEATURED from supabase
        const SUPABASE_URL = "https://mtmrilvgybiwyjgqttqr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bXJpbHZneWJpd3lqZ3F0dHFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4Mjg4OTEsImV4cCI6MjA1NDQwNDg5MX0.1nfCnZmh0jFR9xttubx5b8iaq7awEYPECXLZJNjpHPg";

        // Initialize Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener("DOMContentLoaded", async function () {
            console.log("Supabase Initialized:", supabaseClient);
            await loadFeaturedListings();
        });

        async function loadFeaturedListings() {
            const productContainer = document.querySelector(".grid");

            if (!productContainer) return;

            const categories = ["Sneakers", "Clothing", "Watches", "Electronics"];

            let listings = [];

            for (let category of categories) {
                let { data, error } = await supabaseClient
                    .from("listings")
                    .select("*")
                    .eq("category", category)
                    .limit(1);

                if (error) {
                    console.error(`Error fetching ${category}:`, error);
                    continue;
                }

                if (data.length > 0) {
                    listings.push(data[0]);
                }
            }

            productContainer.innerHTML = ""; // Clear existing listings

            listings.forEach(listing => {
            const listingHTML = `
                <div class="product-item">
                    <div class="product-images">
                        <a href="/product/product.html?id=${listing.id}" class="product-link">
                        <img src="${listing.image_url}" alt="${listing.title}" class="product-img">
                        </a>
                        <div class="overlay">
                        <button class="wishlist-btn" data-product='${JSON.stringify(listing)}' onclick="addToWishlist(this)">
                            <i class='bx bxs-heart'></i>
                        </button>
                        <a href="chats.html" class="chat-btn">
                            <i class='bx bx-message-square-dots'></i>
                        </a>
                        </div>
                    </div>
                    <div class="product-content">
                        <span class="product-category">${listing.category}</span>
                        <h4 class="product-title">${listing.title}</h4>
                        <div class="product-price flex">
                        <span class="new-price">$${listing.price}</span>
                        </div>
                    </div>
                </div>
            `;
            productContainer.innerHTML += listingHTML;
            });
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            // Get references to the search input and the search icon
            const searchInput = document.querySelector(".header-search .form-input");
            const searchIcon = document.querySelector(".header-search i");
        
            // When the user presses Enter in the search input, perform the search
            searchInput.addEventListener("keypress", async function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                await performSearch(searchInput.value.trim());
            }
            });
        
            // When the search icon is clicked, perform the search
            searchIcon.addEventListener("click", async function() {
            await performSearch(searchInput.value.trim());
            });
        });
        
        async function performSearch(query) {
            if (!query) return; // If no query, do nothing
        
            // Query the "listings" table for a title that matches the query (case-insensitive)
            const { data, error } = await supabaseClient
            .from("listings")
            .select("*")
            .ilike("title", `%${query}%`)
            .limit(1); // Limit to one result
        
            if (error) {
            console.error("Error searching listings:", error);
            alert("Error searching for product.");
            return;
            }
        
            if (data && data.length > 0) {
            // Redirect to the product detail page for the first matching listing.
            window.location.href = `/product/product.html?id=${data[0].id}`;
            } else {
            alert("No matching product found.");
            }
        }

        // Debounce function to limit how frequently the search query is sent
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
            }
        }
        
        async function fetchSuggestions(query) {
            if (!query) {
            suggestionsContainer.innerHTML = "";
            suggestionsContainer.style.display = "none";
            return;
            }
            // Query the listings table for matching titles (case-insensitive)
            const { data, error } = await supabaseClient
            .from("listings")
            .select("id, title")
            .ilike("title", `%${query}%`)
            .limit(5);
            if (error) {
            console.error("Error fetching suggestions:", error);
            return;
            }
            suggestionsContainer.innerHTML = "";
            if (data && data.length > 0) {
            data.forEach(item => {
                const suggestionItem = document.createElement("div");
                suggestionItem.classList.add("suggestion-item");
                suggestionItem.textContent = item.title;
                suggestionItem.addEventListener("click", function() {
                // Redirect to the product detail page when a suggestion is clicked
                window.location.href = `/product/product.html?id=${item.id}`;
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
            suggestionsContainer.style.display = "block";
            } else {
            suggestionsContainer.style.display = "none";
            }
        }
        
        const debouncedFetchSuggestions = debounce(fetchSuggestions, 300);
        
        // Get references to the search input, icon, and suggestions container
        document.addEventListener("DOMContentLoaded", function() {
            const searchInput = document.getElementById("search-input");
            const searchIcon = document.getElementById("search-icon");
            window.suggestionsContainer = document.getElementById("search-suggestions");
            
            // When the user types, fetch suggestions
            searchInput.addEventListener("input", function() {
            const query = searchInput.value.trim();
            debouncedFetchSuggestions(query);
            });
            
            searchIcon.addEventListener("click", function() {
            // hide suggestions if visible.
            suggestionsContainer.innerHTML = "";
            suggestionsContainer.style.display = "none";
            });
        });
    </script>
    <script>
        function addToWishlist(button) {
            const productData = button.getAttribute('data-product');
            let product = productData ? JSON.parse(productData) : null;
            if (!product) return;

            let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
            let index = wishlist.findIndex(item => item.id === product.id);

            if (index === -1) {
                wishlist.push(product);
                button.classList.add("added");
                button.style.color = "red";
            } else {
                wishlist.splice(index, 1);
                button.classList.remove("added");
                button.style.color = "#FD5F5F";
            }

            // Save the updated wishlist back to localStorage.
            localStorage.setItem("wishlist", JSON.stringify(wishlist));
            
            loadWishlist();
        }

        function navigateToCategory(categoryPage) {
            window.location.href = `${categoryPage}`;
        }

        // update log in with account page with sidebar
        document.addEventListener('DOMContentLoaded', () => {
            // Check if a user is logged in (saved in localStorage)
            const loggedInUser = localStorage.getItem('loggedInUser');
            const headerAction = document.querySelector('.header-top-action');
        
            if (loggedInUser && headerAction) {
                // Parse the stored user data
                const user = JSON.parse(loggedInUser);
                
                // Replace the login link with an account icon
                headerAction.innerHTML = `<i class='bx bx-user' style="font-size: 24px;"></i>`;
                headerAction.removeAttribute('href');
                
                // When the account icon is clicked, toggle the sidebar
                headerAction.addEventListener('click', toggleSidebar);
            
                // Populate the sidebar with the user's info
                const userInfoDiv = document.getElementById('user-info');
                if (userInfoDiv) {
                    userInfoDiv.innerHTML = `<p><strong>${user.name || 'User'}</strong></p>
                                            <p>${user.email}</p>`;
                }
            } else if (headerAction) {
                // If no user is logged in, ensure the header only shows "Login"
                headerAction.innerHTML = 'Login';
                headerAction.setAttribute('href', '/login/login-signup.html');
            }
        
            // Set up sidebar close button listener
            const closeSidebarBtn = document.getElementById('close-sidebar');
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', toggleSidebar);
            }
        
            // Set up log out button listener
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('loggedInUser');
                    window.location.reload();
                });
            }
        });

        function toggleSidebar() {
        const sidebar = document.getElementById('account-sidebar');
        if (sidebar) {
            sidebar.classList.toggle('open');
        }

        }
    </script>
    <style>
        .product-item {
            width: 100%;
            max-width: 300px;
            position: relative;
        }

        .product-images {
            position: relative;
            overflow: hidden;
            background-color: white;
            transition: background-color 0.3s ease;
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .product-images:hover img {
            filter: brightness(0.35);
        }

        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* This prevents the overlay from intercepting clicks */
            }

            .product-images:hover .overlay {
            opacity: 1;
            }

            .overlay button,
            .overlay a {
            pointer-events: auto; /* This enables clicks on the wishlist and chat icons */
            font-size: 2.2rem;
            color: #FD5F5F;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            }

            .overlay a {
            color: #f1f1f1;
            }

            .overlay button:hover,
            .overlay a:hover {
            color: #FF0000;
            transform: scale(1.1);
            }

            .overlay a:hover {
            color: #fff;
        }

        .wishlist-btn, .chat-btn {
            font-size: 2.2rem;
            color: #FD5F5F;
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        .chat-btn {
            color: #f1f1f1;
        }

        .wishlist-btn:hover, .chat-btn:hover {
            color: #FF0000;
            transform: scale(1.1);
        }

        .chat-btn:hover {
            color: #fff;
        }

        .wishlist-message {
            display: none;
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: black;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.1rem;
            letter-spacing: 0.9px;
            font-family: 'Lato', sans-serif;
            font-weight: bold;
            z-index: 1000;
        }
    </style>
</body>
</html>